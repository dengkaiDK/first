import os
import tarfile
import _pickle as cPickle
import numpy as np
import urllib.request
import scipy.misc
import matplotlib.pyplot as plt
import tensorflow as tf
cifar_link='https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz'
file_dir='temp'#临时文件夹名称
if not os.path.isdir(file_dir):
  os.makedirs(file_dir)#若没有，创建文件夹
objects=['a','b','c','d','e','f','g','h','i','j']#目标分类
target_file=os.path.join(file_dir,'cifar-10-python.tar.gz')  #在文件夹下加入target路径（连接），如果不写入，文件不存在
if not os.path.isfile(target_file):
  print('CIFAR-10 file not found. Downloading CIFAR data (size=163MB)')
  print('THIS may take a few minutes,please wait.')
  filename,headers=urllib.request.urlretrieve(cifar_link,target_file)#从网站上获取数据并且写入到target_file文件夹中
tar=tarfile.open(target_file)#打开
tar.extractall(path=file_dir)#解压路径下所有压缩文件
tar.close()

def file_name2(file_dir):   #打开用户自建的特定类型的文件
    L=[]   
    for root, dirs, files in os.walk(file_dir):  
        for file in files:  
            if os.path.splitext(file)[1] == '.jpg':   
                L.append(os.path.join(root, file))  
    return L 

path = file_name2('temp')#建立一个读取temp下所有jpg格式图片文件的列表

train_folder='train_dir'
if not os.path.isdir(os.path.join(file_dir,train_folder)):
  for i in range(10):
    folder=os.path.join(file_dir,train_folder,objects[i])
    os.makedirs(folder)
test_folder='validation_dir'
if not os.path.isdir(os.path.join(file_dir,test_folder)):
  for i in range(10):
    folder=os.path.join(file_dir,test_folder,objects[i])
    os.makedirs(folder)
def load_batch_from_file(file):
  file_conn=open(file,'rb')
  image_dictionary=cPickle.load(file_conn,encoding='latin1')
  file_conn.close()
  return (image_dictionary)
def save_images_from_dict(image_dict,folders='file_dir'):
  for ix,label in enumerate(image_dict['labels']):
    folder_path=os.path.join(file_dir,folder,objects[label])
    filename=image_dict['filenames'][ix]
    image_array=image_dict['data'][ix]
    image_array.resize([3,32,32])
    output_location=os.path.join(folder_path,filename)
    scipy.misc.imsave(output_location,image_array.transpose())
data_location=os.path.join(file_dir,'cifar-10-batches-py')
train_names=['data_batch_'+str(x) for x in range(1,6)]
test_names=['test_batch']
#sort train images
for file in train_images:
  print('Saving images from file: {}'.format(file))
  file_location=os.path.join(file_dir,'cifar-10-batches-py',file)
  image_dict=load_batch_from_file(file_location)
  save_images_from_dict(image_dict,folder=train_folder)
for file in test_names:
  print('Saving images from file: {}'.format(file))
  file_location=os.path.join(file_dir,'cifar-10-batches-py',file)
  image_dict=load_batch_from_file(file_location)
  save_images_from_dict(image_dict,folder=test_folder)

cifar_labels_file=os.path.join(data_dir,'cifar10_labels.txt')
print('Writing labels file,{}'.format(cifar_labels_file))
with open(cifar_labels_file,'w') as labels_file:
  for item in objects:
    labels_file_write('{}\n'.format(item))#创建标注文件
